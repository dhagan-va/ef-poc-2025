# EDI 837 Ingestion POC

Proof‑of‑concept for ingesting HIPAA 837/835 EDI files, validating them with EdiFabric, and persisting to SQL Server with EF Core. Includes a mocked S3 workflow via moto for local testing.

## Prerequisites
- .NET 9 SDK  
- SQL Server LocalDB (default connection used)  
- Python 3.8+ with `pip`  
- Moto for S3 mocking (`pip install moto`)

## Project Structure
```
david-m/
  src/
    EDI.Common/     // shared models/constants
    EDI.Data/       // EF Core DbContext + migrations
    EDI.Services/   // ingestion + validation services
    EDI.Console/    // runner that pulls/ingests from S3
    ef-poc-2025.sln // solution file
    setup_moto.py   // create bucket + upload sample
    start_moto_server.py
  tests/
    EDI.Services.Tests/
```

## Setup & Run
1) Start moto S3 mock server  
```bash
cd david-m/src
python start_moto_server.py  # starts moto S3 on :5000
```

2) Seed the bucket with the sample file  
```bash
cd david-m/src
python setup_moto.py        # creates bucket 'edi-837-bucket' and uploads /samples/ClaimPayment.txt
```

3) Apply database migrations (creates tables + reporting view `dbo.vw_EdiFileIngestion`)  
```bash
cd david-m
dotnet ef database update --project src/EDI.Data --startup-project src/EDI.Console --context EdiDbContext
```
> Connection string defaults to LocalDB in `EDI.Console/Program.cs`. Adjust there or via user secrets/env vars if needed.

4) Run the console ingester  
```bash
cd david-m/src/EDI.Console
dotnet run
```
The app will download files from `edi-837-bucket`, parse/validate them, persist transactions, and move objects under `success/` or `failed/` in the mock S3 bucket.

## Where Data Lands
- Core tables: `T837PTransactions`, `T837ITransactions`, `T837DTransactions`, plus related segment tables generated by EF/EdiFabric models.
- Reporting view: `dbo.vw_EdiFileIngestion` (joins ST/BHT/TRN/DTM with transaction rows). Quick check:
```sql
SELECT TOP (50) * FROM dbo.vw_EdiFileIngestion ORDER BY TransactionSetCreationDate, TransactionSetCreationTime;
```

## Tests
```bash
cd david-m/tests/EDI.Services.Tests
dotnet test
```

## Notes
- EdiFabric serial key is set in code for the POC; replace with your key via env var `EDIFABRIC_SERIAL_KEY` for real use.
- S3 endpoint is read from `AWS_SERVICE_URL` (defaults to `http://localhost:5000` for moto). Update for real AWS.
- Solution file `src/ef-poc-2025.sln` uses relative paths rooted at `david-m/src`.

## Useful Commands
- Rebuild solution: `dotnet build david-m/src/ef-poc-2025.sln`
- List migrations: `dotnet ef migrations list --project src/EDI.Data --startup-project src/EDI.Console --context EdiDbContext`
